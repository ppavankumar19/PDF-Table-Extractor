<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TablePull — PDF Table Extractor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg:          #f5f7fc;
      --bg2:         #eef1f9;
      --surface:     #ffffff;
      --surface-2:   #f9fafd;
      --border:      #e3e8f4;
      --border-2:    #ccd4ec;
      --ink:         #0f1628;
      --ink-2:       #3d4a6b;
      --ink-3:       #8892b0;
      --accent:      #2563eb;
      --accent-soft: #eff4ff;
      --green:       #16a34a;
      --green-soft:  #f0fdf4;
      --amber:       #d97706;
      --amber-soft:  #fffbeb;
      --red:         #dc2626;
      --red-soft:    #fef2f2;
      --radius:      16px;
      --radius-sm:   10px;
      --radius-xs:   6px;
      --shadow-sm:   0 1px 4px rgba(15,22,40,0.06), 0 4px 12px rgba(15,22,40,0.06);
      --shadow-md:   0 4px 16px rgba(15,22,40,0.08), 0 12px 36px rgba(15,22,40,0.08);
      --t:           0.18s cubic-bezier(0.4,0,0.2,1);
      --font-display:'Instrument Serif', Georgia, serif;
      --font-body:   'Plus Jakarta Sans', system-ui, sans-serif;
      --font-mono:   'JetBrains Mono', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-body); background: var(--bg); color: var(--ink); min-height: 100vh; -webkit-font-smoothing: antialiased; }

    /* ── LAYOUT ── */
    .app { max-width: 1200px; margin: 0 auto; padding: 28px 20px 72px; display: grid; gap: 22px; }

    /* ── TOPBAR ── */
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 0 2px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-icon { width: 38px; height: 38px; background: var(--accent); border-radius: 10px; display: grid; place-items: center; box-shadow: 0 4px 14px rgba(37,99,235,.35); color: #fff; flex-shrink: 0; }
    .brand-name { font-size: 20px; font-weight: 800; letter-spacing: -0.04em; }
    .brand-name span { color: var(--accent); }
    .topbar-tag { font-size: 13px; color: var(--ink-3); background: var(--surface); border: 1px solid var(--border); padding: 7px 14px; border-radius: 20px; box-shadow: var(--shadow-sm); }

    /* ── STEPS ── */
    .steps { display: flex; align-items: center; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 24px; box-shadow: var(--shadow-sm); overflow-x: auto; gap: 0; }
    .step { display: flex; align-items: center; gap: 9px; flex-shrink: 0; transition: opacity var(--t); }
    .step.inactive { opacity: 0.35; }
    .step-num { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border-2); display: grid; place-items: center; font-size: 12px; font-weight: 700; color: var(--ink-3); background: var(--bg2); flex-shrink: 0; transition: all var(--t); }
    .step.active .step-num { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,.35); }
    .step.done .step-num   { background: var(--green);  border-color: var(--green);  color: #fff; }
    .step-label { font-size: 13px; font-weight: 600; color: var(--ink-2); white-space: nowrap; }
    .step.active .step-label { color: var(--accent); }
    .step.done   .step-label { color: var(--green);  }
    .step-sep { flex: 1; height: 1px; background: var(--border); margin: 0 14px; min-width: 20px; }

    /* ── MAIN GRID ── */
    .main-grid { display: grid; grid-template-columns: 360px 1fr; gap: 20px; align-items: start; }
    @media (max-width: 880px) { .main-grid { grid-template-columns: 1fr; } }

    /* ── UPLOAD CARD ── */
    .upload-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-md); overflow: hidden; position: sticky; top: 20px; }
    .card-hero {
      background: linear-gradient(140deg, #2563eb 0%, #1d4ed8 55%, #1e40af 100%);
      padding: 22px 24px; position: relative; overflow: hidden;
    }
    .card-hero::before {
      content: ''; position: absolute; inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E");
    }
    .card-eyebrow { font-size: 11px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: rgba(255,255,255,.7); margin-bottom: 6px; }
    .card-hero h2 { font-family: var(--font-display); font-size: 22px; font-style: italic; color: #fff; line-height: 1.25; margin-bottom: 16px; }
    .fpills { display: flex; flex-wrap: wrap; gap: 6px; }
    .fpill { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,.13); border: 1px solid rgba(255,255,255,.18); border-radius: 20px; padding: 5px 10px; font-size: 12px; font-weight: 600; color: #fff; }
    .fdot { width: 6px; height: 6px; border-radius: 50%; background: #86efac; }
    .card-body { padding: 20px 24px 24px; display: grid; gap: 14px; }

    /* ── DROPZONE ── */
    .dropzone { border: 2px dashed var(--border-2); border-radius: var(--radius-sm); padding: 22px 18px; cursor: pointer; text-align: center; background: var(--surface-2); transition: all var(--t); position: relative; }
    .dropzone:hover, .dropzone.dragging { border-color: var(--accent); background: var(--accent-soft); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(37,99,235,.12); }
    .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .dz-icon { width: 42px; height: 42px; background: var(--accent-soft); border: 1px solid var(--border); border-radius: 11px; display: grid; place-items: center; margin: 0 auto 10px; color: var(--accent); transition: all var(--t); }
    .dropzone:hover .dz-icon, .dropzone.dragging .dz-icon { background: var(--accent); color: #fff; border-color: var(--accent); }
    .dz-title { font-size: 14px; font-weight: 700; color: var(--ink); margin-bottom: 3px; }
    .dz-sub   { font-size: 12px; color: var(--ink-3); }

    /* file row */
    .file-row { display: none; align-items: center; gap: 10px; padding: 10px 13px; background: var(--green-soft); border: 1px solid #bbf7d0; border-radius: var(--radius-sm); animation: slideDown .2s ease; }
    .file-row.show { display: flex; }
    .file-name { font-size: 13px; font-weight: 600; color: var(--green); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .clear-btn { border: none; background: none; cursor: pointer; color: var(--ink-3); display: grid; place-items: center; padding: 2px; border-radius: 4px; transition: color var(--t); flex-shrink: 0; }
    .clear-btn:hover { color: var(--red); }

    /* pdf thumb */
    .pdf-thumb { width: 100%; height: 190px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface-2); display: none; overflow: hidden; }
    .pdf-thumb embed { width: 100%; height: 100%; }

    /* ── BUTTONS ── */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 7px; border: none; border-radius: var(--radius-sm); font-family: var(--font-body); font-weight: 700; cursor: pointer; transition: all var(--t); white-space: nowrap; text-decoration: none; font-size: 14px; }
    .btn:disabled { opacity: .5; cursor: not-allowed; pointer-events: none; }
    .btn-primary  { background: var(--accent); color: #fff; padding: 13px 20px; box-shadow: 0 4px 14px rgba(37,99,235,.32); width: 100%; }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,.4); }
    .btn-dl       { background: var(--green); color: #fff; padding: 13px 20px; box-shadow: 0 4px 14px rgba(22,163,74,.28); width: 100%; }
    .btn-dl:hover { background: #15803d; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(22,163,74,.36); }
    .btn-icon     { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xs); padding: 8px; color: var(--ink-2); }
    .btn-icon:hover { background: var(--bg2); color: var(--ink); }
    .btn-row { display: grid; gap: 10px; }

    /* status */
    .status-bar { display: flex; align-items: center; gap: 8px; padding: 10px 13px; border-radius: var(--radius-xs); font-size: 13px; font-weight: 600; }
    .status-bar.idle    { background: var(--bg2);       color: var(--ink-3); }
    .status-bar.ok      { background: var(--green-soft); color: var(--green); }
    .status-bar.warn    { background: var(--amber-soft); color: var(--amber); }
    .status-bar.error   { background: var(--red-soft);   color: var(--red);   }
    .status-bar.loading { background: var(--accent-soft);color: var(--accent);}
    .s-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .idle    .s-dot { background: var(--ink-3); }
    .ok      .s-dot { background: var(--green);  animation: pgn 1.8s infinite; }
    .warn    .s-dot { background: var(--amber); }
    .error   .s-dot { background: var(--red); }
    .loading .s-dot { background: var(--accent); animation: pbl 1.1s infinite; }
    @keyframes pgn { 0%,100%{ box-shadow:0 0 0 0 rgba(22,163,74,.4)  } 50%{ box-shadow:0 0 0 5px rgba(22,163,74,0)   } }
    @keyframes pbl { 0%,100%{ box-shadow:0 0 0 0 rgba(37,99,235,.4)  } 50%{ box-shadow:0 0 0 5px rgba(37,99,235,0)   } }
    .prog-wrap { height: 3px; background: var(--border); border-radius: 4px; display: none; }
    .prog-wrap.show { display: block; }
    .prog-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width .4s ease; width: 0%; }

    /* ── PREVIEW CARD ── */
    .preview-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-md); overflow: hidden; }
    .prev-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 16px 22px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .prev-header-l { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
    .prev-h-icon { width: 36px; height: 36px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; display: grid; place-items: center; color: var(--ink-2); flex-shrink: 0; }
    .prev-h-title { font-size: 15px; font-weight: 700; }
    .prev-h-sub   { font-size: 12px; color: var(--ink-3); margin-top: 1px; }
    .prev-header-r { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .badge { padding: 5px 11px; border-radius: 20px; font-size: 12px; font-weight: 700; background: var(--bg2); color: var(--ink-2); border: 1px solid var(--border); white-space: nowrap; }
    .badge.hi { background: var(--accent-soft); color: var(--accent); border-color: #bfdbfe; }

    /* toolbar */
    .prev-toolbar { display: flex; align-items: center; gap: 8px; padding: 11px 22px; border-bottom: 1px solid var(--border); background: var(--surface-2); flex-wrap: wrap; }
    .tabs-row { display: flex; gap: 6px; flex: 1; overflow-x: auto; min-width: 0; }
    .tab { display: flex; align-items: center; gap: 5px; padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius-xs); background: var(--surface); font-size: 13px; font-weight: 600; color: var(--ink-2); cursor: pointer; white-space: nowrap; transition: all var(--t); }
    .tab:hover { background: var(--bg2); color: var(--ink); }
    .tab.active { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 3px 10px rgba(37,99,235,.28); }
    .tab-cnt { font-size: 11px; font-weight: 700; background: rgba(255,255,255,.25); border-radius: 4px; padding: 1px 5px; }
    .tab:not(.active) .tab-cnt { background: var(--bg2); color: var(--ink-3); }
    .search-wrap { position: relative; flex-shrink: 0; }
    .search-wrap svg { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); color: var(--ink-3); pointer-events: none; }
    .search-in { border: 1px solid var(--border); border-radius: var(--radius-xs); padding: 7px 12px 7px 30px; font-family: var(--font-body); font-size: 13px; color: var(--ink); background: var(--surface); outline: none; width: 175px; transition: all var(--t); }
    .search-in:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }

    /* meta bar */
    .meta-bar { display: flex; align-items: center; gap: 8px; padding: 9px 22px; border-bottom: 1px solid var(--border); background: var(--surface); flex-wrap: wrap; display: none; }
    .pill { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; background: var(--bg2); color: var(--ink-2); border: 1px solid var(--border); }
    .pill-hi { background: var(--accent-soft); color: var(--accent); border-color: #bfdbfe; }
    .meta-sp { flex: 1; }

    /* table */
    .tbl-scroll { overflow: auto; max-height: 520px; }
    .tbl-scroll::-webkit-scrollbar { width: 7px; height: 7px; }
    .tbl-scroll::-webkit-scrollbar-track { background: var(--bg2); }
    .tbl-scroll::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 4px; }
    .tbl-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    table.grid { width: max(100%,600px); border-collapse: collapse; font-size: 13.5px; }
    table.grid thead th { position: sticky; top: 0; z-index: 4; background: #0f1628; color: #e2e8f8; font-size: 11.5px; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; padding: 10px 12px; border-right: 1px solid rgba(255,255,255,.07); white-space: nowrap; }
    table.grid thead th:first-child { width: 50px; text-align: center; background: #0a0f1e; z-index: 5; position: sticky; left: 0; }
    table.grid tbody tr:hover td, table.grid tbody tr:hover th { background: var(--accent-soft) !important; }
    table.grid tbody tr.smatch td, table.grid tbody tr.smatch th { outline: 2px solid var(--accent); outline-offset: -1px; }
    table.grid td { padding: 8px 12px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); background: var(--surface); color: var(--ink); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle; transition: background var(--t); }
    table.grid td.mhit { background: #fef9c3 !important; }
    table.grid td span.mhl { background: #fde047; border-radius: 2px; padding: 0 2px; }
    table.grid tbody th.rn { position: sticky; left: 0; z-index: 2; background: var(--bg2); color: var(--ink-3); font-size: 11px; font-family: var(--font-mono); font-weight: 500; padding: 8px; text-align: center; border-right: 1px solid var(--border-2); border-bottom: 1px solid var(--border); width: 50px; white-space: nowrap; }
    table.grid tbody tr:hover th.rn { background: #dce5f9; }

    /* empty */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; min-height: 300px; padding: 40px; color: var(--ink-3); text-align: center; }
    .empty-ico { width: 54px; height: 54px; background: var(--bg2); border: 1px solid var(--border); border-radius: 14px; display: grid; place-items: center; color: var(--ink-3); }
    .empty h4 { font-size: 15px; font-weight: 700; color: var(--ink-2); }
    .empty p  { font-size: 13px; max-width: 250px; line-height: 1.55; }

    /* ── TOAST ── */
    #toasts { position: fixed; bottom: 26px; right: 22px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { display: flex; align-items: center; gap: 10px; background: #0f1628; color: #e2e8f8; padding: 13px 16px; border-radius: 12px; font-size: 14px; font-weight: 600; box-shadow: 0 8px 28px rgba(0,0,0,.3); pointer-events: all; animation: tin .25s cubic-bezier(.34,1.56,.64,1); max-width: 310px; }
    .toast.out { animation: tout .2s ease forwards; }
    .toast-g { border-left: 3px solid var(--green); }
    .toast-b { border-left: 3px solid var(--accent); }
    .toast-r { border-left: 3px solid var(--red); }
    @keyframes tin  { from{opacity:0;transform:translateX(18px)} to{opacity:1;transform:translateX(0)} }
    @keyframes tout { from{opacity:1;transform:translateX(0)}     to{opacity:0;transform:translateX(18px)} }

    @keyframes spin      { to { transform: rotate(360deg); } }
    @keyframes slideDown { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
    .spin { animation: spin .75s linear infinite; display: inline-block; }

    @media (max-width: 640px) {
      .topbar-tag { display: none; }
      .search-in  { width: 130px; }
    }
  </style>
</head>
<body>
<div id="toasts"></div>
<main class="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      </div>
      <span class="brand-name">Table<span>Pull</span></span>
    </div>
    <span class="topbar-tag">PDF → Excel in seconds</span>
  </header>

  <!-- STEPS -->
  <nav class="steps">
    <div class="step active" id="s1"><div class="step-num">1</div><span class="step-label">Upload PDF</span></div>
    <div class="step-sep"></div>
    <div class="step inactive" id="s2"><div class="step-num">2</div><span class="step-label">Analyze</span></div>
    <div class="step-sep"></div>
    <div class="step inactive" id="s3"><div class="step-num">3</div><span class="step-label">Preview</span></div>
    <div class="step-sep"></div>
    <div class="step inactive" id="s4"><div class="step-num">4</div><span class="step-label">Download Excel</span></div>
  </nav>

  <!-- GRID -->
  <div class="main-grid">

    <!-- LEFT -->
    <aside class="upload-card">
      <div class="card-hero">
        <p class="card-eyebrow">PDF → Excel</p>
        <h2>Extract tables with<br/>highlight colors intact.</h2>
        <div class="fpills">
          <div class="fpill"><span class="fdot"></span>Cell highlights</div>
          <div class="fpill"><span class="fdot"></span>Multi-sheet</div>
          <div class="fpill"><span class="fdot"></span>Instant preview</div>
        </div>
      </div>

      <div class="card-body">
        <form id="uform" action="/extract" method="post" enctype="multipart/form-data">

          <label class="dropzone" id="dz" for="fi">
            <div class="dz-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
            </div>
            <div class="dz-title" id="dz-title">Choose a PDF or drop it here</div>
            <div class="dz-sub">PDF files only &middot; Max 50 MB</div>
            <input type="file" id="fi" name="file" accept="application/pdf" required />
          </label>

          <div class="file-row" id="frow">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--green);flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
            <span class="file-name" id="fname"></span>
            <button type="button" class="clear-btn" id="clrbtn" aria-label="Remove">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>

          <div class="pdf-thumb" id="pthumb"><embed id="pembed" type="application/pdf" style="width:100%;height:100%"/></div>

          <div class="btn-row">
            <button type="submit" class="btn btn-primary" id="abtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Analyze Tables
            </button>
            <button type="button" class="btn btn-dl" id="dlbtn" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Download Excel
            </button>
          </div>

          <div class="status-bar idle" id="sbar">
            <span class="s-dot"></span>
            <span id="stxt">Waiting for a PDF</span>
          </div>
          <div class="prog-wrap" id="pwrap"><div class="prog-fill" id="pfill"></div></div>
        </form>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="preview-card" id="prev-card">
      <div class="prev-header">
        <div class="prev-header-l">
          <div class="prev-h-icon">
            <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </div>
          <div>
            <div class="prev-h-title">Workbook Preview</div>
            <div class="prev-h-sub">Excel-style view of every extracted table</div>
          </div>
        </div>
        <div class="prev-header-r">
          <div class="badge" id="tcount">No tables</div>
          <button type="button" class="btn btn-icon" id="csvbtn" title="Copy sheet as CSV" style="display:none">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
          <button type="button" class="btn btn-icon" id="fsbtn" title="Fullscreen" style="display:none">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
          </button>
        </div>
      </div>

      <div class="prev-toolbar">
        <div class="tabs-row" id="stabs"></div>
        <div class="search-wrap">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" class="search-in" id="srch" placeholder="Search rows…" autocomplete="off"/>
        </div>
      </div>

      <div class="meta-bar" id="mbar">
        <span class="pill pill-hi" id="mrows">—</span>
        <span class="pill" id="mcols">—</span>
        <span class="pill" id="msheet">—</span>
        <div class="meta-sp"></div>
        <span class="pill" style="color:var(--ink-3);font-size:11px">Highlights preserved · Row numbers pinned</span>
      </div>

      <div id="tarea">
        <div class="empty" id="estate">
          <div class="empty-ico">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </div>
          <h4>No tables yet</h4>
          <p>Upload a PDF and click Analyze Tables to see a live workbook preview here.</p>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  /* ── STATE ── */
  let tables = [], activeIdx = 0, blobUrl = null, dlName = null;

  /* ── ELEMENTS ── */
  const fi    = document.getElementById('fi');
  const dz    = document.getElementById('dz');
  const dzT   = document.getElementById('dz-title');
  const frow  = document.getElementById('frow');
  const fname = document.getElementById('fname');
  const clr   = document.getElementById('clrbtn');
  const pthumb= document.getElementById('pthumb');
  const pembd = document.getElementById('pembed');
  const abtn  = document.getElementById('abtn');
  const dlbtn = document.getElementById('dlbtn');
  const sbar  = document.getElementById('sbar');
  const stxt  = document.getElementById('stxt');
  const pw    = document.getElementById('pwrap');
  const pf    = document.getElementById('pfill');
  const stabs = document.getElementById('stabs');
  const tarea = document.getElementById('tarea');
  const estat = document.getElementById('estate');
  const tcount= document.getElementById('tcount');
  const mbar  = document.getElementById('mbar');
  const mrows = document.getElementById('mrows');
  const mcols = document.getElementById('mcols');
  const msht  = document.getElementById('msheet');
  const srch  = document.getElementById('srch');
  const csvb  = document.getElementById('csvbtn');
  const fsb   = document.getElementById('fsbtn');
  const form  = document.getElementById('uform');

  /* ── STEPS ── */
  function setStep(n) {
    for (let i=1;i<=4;i++) {
      const el=document.getElementById('s'+i);
      el.className = i<n ? 'step done' : i===n ? 'step active' : 'step inactive';
    }
  }

  /* ── TOAST ── */
  function toast(msg, type='b') {
    const tc=document.getElementById('toasts'), d=document.createElement('div');
    d.className=`toast toast-${type}`;
    const ic={g:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',b:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',r:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'};
    d.innerHTML=`${ic[type]||ic.b}<span>${msg}</span>`;
    tc.appendChild(d);
    setTimeout(()=>{ d.classList.add('out'); setTimeout(()=>d.remove(),220); },3000);
  }

  /* ── STATUS ── */
  function st(text, tone='idle') { sbar.className=`status-bar ${tone}`; stxt.textContent=text; }
  function prog(pct, show=true)  { pw.classList.toggle('show',show); pf.style.width=pct+'%'; }

  /* ── FILE ── */
  fi.addEventListener('change', onFile);
  clr.addEventListener('click', clearFile);
  function onFile() {
    const f=fi.files[0]; if(!f) return;
    dzT.textContent=f.name;
    fname.textContent=`${f.name} — ${(f.size/1024/1024).toFixed(2)} MB`;
    frow.classList.add('show');
    pembd.src=URL.createObjectURL(f);
    pthumb.style.display='block';
    st('PDF loaded — click Analyze Tables.','ok');
    setStep(1); resetPrev(); dlbtn.disabled=true; csvb.style.display='none'; fsb.style.display='none';
  }
  function clearFile() {
    fi.value=''; dzT.textContent='Choose a PDF or drop it here';
    frow.classList.remove('show'); pthumb.style.display='none'; pembd.removeAttribute('src');
    st('Waiting for a PDF','idle'); prog(0,false); setStep(1); resetPrev();
    dlbtn.disabled=true; csvb.style.display='none'; fsb.style.display='none'; blobUrl=null;
  }
  /* drag */
  ['dragover','dragenter'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('dragging');}));
  ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('dragging');}));
  dz.addEventListener('drop',ev=>{
    const f=ev.dataTransfer?.files?.[0]; if(!f) return;
    if(f.type!=='application/pdf'){toast('Please drop a PDF file.','r');return;}
    const dt=new DataTransfer(); dt.items.add(f); fi.files=dt.files; onFile();
  });

  /* ── RESET ── */
  function resetPrev() {
    tables=[]; activeIdx=0; stabs.innerHTML='';
    tarea.innerHTML=''; tarea.appendChild(estat);
    tcount.textContent='No tables'; tcount.className='badge';
    mbar.style.display='none';
  }

  /* ── TABS ── */
  function renderTabs() {
    stabs.innerHTML='';
    tables.forEach((t,i)=>{
      const b=document.createElement('button'); b.type='button';
      b.className=`tab ${i===activeIdx?'active':''}`;
      b.innerHTML=`${t.title||`Sheet ${i+1}`}<span class="tab-cnt">${t.rows?.length??0}</span>`;
      b.addEventListener('click',()=>{activeIdx=i;renderTabs();renderTable();});
      stabs.appendChild(b);
    });
  }

  /* ── TABLE ── */
  function renderTable(q='') {
    if(!tables.length){ tarea.innerHTML=''; tarea.appendChild(estat); mbar.style.display='none'; return; }
    const t=tables[activeIdx], cols=t.rows.reduce((m,r)=>Math.max(m,r.length),0), s=q.toLowerCase().trim();
    mrows.textContent=`${t.rows.length} rows`; mcols.textContent=`${cols} cols`;
    msht.textContent=`Sheet ${activeIdx+1} of ${tables.length}`;
    mbar.style.display='flex';
    const wrap=document.createElement('div'); wrap.className='tbl-scroll';
    const tbl=document.createElement('table'); tbl.className='grid';
    /* head */
    const hd=document.createElement('thead'), hr=document.createElement('tr');
    const ch=document.createElement('th'); ch.textContent='#'; hr.appendChild(ch);
    for(let c=0;c<cols;c++){const th=document.createElement('th');th.textContent=`C${c+1}`;hr.appendChild(th);}
    hd.appendChild(hr); tbl.appendChild(hd);
    /* body */
    const tb=document.createElement('tbody'); let hits=0;
    t.rows.forEach((row,ri)=>{
      const tr=document.createElement('tr');
      const rh=document.createElement('th'); rh.className='rn'; rh.textContent=ri+1; tr.appendChild(rh);
      let rowHit=false;
      for(let c=0;c<cols;c++){
        const td=document.createElement('td'), cell=row[c]??'', color=t.highlights?.[ri]?.[c];
        if(color) td.style.background=`#${color.slice(2)}`;
        if(s && String(cell).toLowerCase().includes(s)){
          rowHit=true; td.classList.add('mhit');
          td.innerHTML=String(cell).replace(new RegExp(`(${esc(s)})`, 'gi'),'<span class="mhl">$1</span>');
        } else { td.textContent=cell; }
        tr.appendChild(td);
      }
      if(s&&rowHit){tr.classList.add('smatch');hits++;}
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); wrap.appendChild(tbl); tarea.innerHTML=''; tarea.appendChild(wrap);
    if(s) { if(!hits) toast(`No matches for "${q}"`,'r'); else toast(`${hits} matching row${hits>1?'s':''}`,'b'); }
  }
  function esc(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
  let stimer; srch.addEventListener('input',()=>{clearTimeout(stimer);stimer=setTimeout(()=>renderTable(srch.value),240);});

  /* ── ANALYZE ── */
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!fi.files.length){toast('Please choose a PDF first.','r');return;}
    abtn.disabled=true;
    abtn.innerHTML=`<span class="spin"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></span>Analyzing…`;
    st('Analyzing tables…','loading'); prog(20,true); setStep(2); resetPrev(); dlbtn.disabled=true;
    const fd=new FormData(form);
    try {
      let p=20; const tk=setInterval(()=>{p=Math.min(p+7,82);prog(p);},450);
      const r=await fetch('/analyze',{method:'POST',body:fd});
      clearInterval(tk);
      if(!r.ok) throw new Error((await r.text())||'Analyze failed.');
      const res=await r.json();
      prog(100);
      if(res.table_count===0){
        st('No tables found in this PDF.','warn'); toast('No tables found. Try another PDF.','r');
        prog(0,false); return;
      }
      tables=res.tables||[]; activeIdx=0;
      const n=res.table_count;
      tcount.textContent=`${n} table${n>1?'s':''} found`; tcount.className='badge hi';
      renderTabs(); renderTable();
      st(`${n} table${n>1?'s':''} ready — preparing download…`,'ok');
      toast(`${n} table${n>1?'s':''} detected!`,'g'); setStep(3);
      csvb.style.display='grid'; fsb.style.display='grid';
      /* fetch xlsx */
      prog(80,true);
      const fd2=new FormData(form), dr=await fetch('/extract',{method:'POST',body:fd2});
      if(!dr.ok) throw new Error((await dr.text())||'Download prep failed.');
      const blob=await dr.blob();
      blobUrl=URL.createObjectURL(blob);
      dlName=(fi.files[0]?.name?.replace(/\.pdf$/i,'')||'tables')+'-tables.xlsx';
      dlbtn.disabled=false; setStep(4);
      st(`Excel ready. Click "Download Excel" to save.`,'ok');
      prog(100); setTimeout(()=>prog(0,false),700);
    } catch(err){
      console.error(err); st(err.message||'Something went wrong.','error');
      toast(err.message||'Something went wrong.','r'); prog(0,false);
    } finally {
      abtn.disabled=false;
      abtn.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Analyze Tables`;
    }
  });

  /* ── DOWNLOAD ── */
  dlbtn.addEventListener('click',()=>{
    if(!blobUrl) return;
    const a=document.createElement('a'); a.href=blobUrl; a.download=dlName;
    document.body.appendChild(a); a.click(); a.remove();
    toast('Excel file downloaded!','g');
  });

  /* ── COPY CSV ── */
  csvb.addEventListener('click',()=>{
    if(!tables.length) return;
    const t=tables[activeIdx];
    const csv=t.rows.map(r=>r.map(c=>`"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
    navigator.clipboard.writeText(csv).then(()=>toast('CSV copied to clipboard!','g')).catch(()=>toast('Copy failed.','r'));
  });

  /* ── FULLSCREEN ── */
  fsb.addEventListener('click',()=>{
    const card=document.getElementById('prev-card');
    if(!document.fullscreenElement) card.requestFullscreen?.();
    else document.exitFullscreen?.();
  });
  document.addEventListener('fullscreenchange',()=>{
    fsb.innerHTML=document.fullscreenElement
      ?`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="10" y1="14" x2="3" y2="21"/><line x1="21" y1="3" x2="14" y2="10"/></svg>`
      :`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>`;
  });
</script>
</body>
</html>
