<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TablePull — Extract PDF Tables to Excel Instantly</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg:          #f5f7fc;
      --bg2:         #eef1f9;
      --surface:     #ffffff;
      --surface-2:   #f9fafd;
      --border:      #e3e8f4;
      --border-2:    #ccd4ec;
      --ink:         #0f1628;
      --ink-2:       #3d4a6b;
      --ink-3:       #8892b0;
      --accent:      #2563eb;
      --accent-soft: #eff4ff;
      --accent-hover:#1d4ed8;
      --green:       #16a34a;
      --green-soft:  #f0fdf4;
      --amber:       #d97706;
      --amber-soft:  #fffbeb;
      --red:         #dc2626;
      --red-soft:    #fef2f2;
      --radius:      16px;
      --radius-sm:   10px;
      --radius-xs:   6px;
      --shadow-sm:   0 1px 4px rgba(15,22,40,0.06), 0 4px 12px rgba(15,22,40,0.06);
      --shadow-md:   0 4px 16px rgba(15,22,40,0.08), 0 12px 36px rgba(15,22,40,0.08);
      --shadow-lg:   0 8px 24px rgba(15,22,40,0.12), 0 16px 48px rgba(15,22,40,0.12);
      --t:           0.18s cubic-bezier(0.4,0,0.2,1);
      --t-slow:      0.35s cubic-bezier(0.4,0,0.2,1);
      --font-display:'Instrument Serif', Georgia, serif;
      --font-body:   'Plus Jakarta Sans', system-ui, sans-serif;
      --font-mono:   'JetBrains Mono', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: var(--font-body); 
      background: linear-gradient(135deg, #f5f7fc 0%, #e8ecf9 100%);
      color: var(--ink); 
      min-height: 100vh; 
      -webkit-font-smoothing: antialiased; 
      line-height: 1.6;
    }

    /* ── LAYOUT ── */
    .app { 
      max-width: 1280px; 
      margin: 0 auto; 
      padding: 32px 24px 80px; 
      display: grid; 
      gap: 28px; 
    }

    /* ── TOPBAR ── */
    .topbar { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 16px; 
      padding: 0 4px;
      animation: fadeSlideDown 0.5s ease-out;
    }
    .brand { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    .brand-icon { 
      width: 42px; 
      height: 42px; 
      background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
      border-radius: 11px; 
      display: grid; 
      place-items: center; 
      box-shadow: 0 6px 20px rgba(37,99,235,.4), 0 0 0 3px rgba(37,99,235,.1);
      color: #fff; 
      flex-shrink: 0;
      transition: all var(--t);
    }
    .brand-icon:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 28px rgba(37,99,235,.5), 0 0 0 4px rgba(37,99,235,.15);
    }
    .brand-name { 
      font-size: 22px; 
      font-weight: 800; 
      letter-spacing: -0.04em;
      background: linear-gradient(135deg, var(--ink) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .brand-tagline {
      font-size: 13px;
      color: var(--ink-3);
      font-weight: 500;
      margin-top: 2px;
    }
    .topbar-tag { 
      font-size: 13px; 
      color: var(--ink-2); 
      background: var(--surface); 
      border: 1px solid var(--border); 
      padding: 8px 16px; 
      border-radius: 24px; 
      box-shadow: var(--shadow-sm);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .topbar-tag svg {
      color: var(--green);
    }

    /* ── STEPS ── */
    .steps-wrapper {
      animation: fadeSlideUp 0.6s ease-out 0.1s both;
    }
    .steps { 
      display: flex; 
      align-items: center; 
      background: var(--surface); 
      border: 1px solid var(--border); 
      border-radius: var(--radius); 
      padding: 18px 28px; 
      box-shadow: var(--shadow-md); 
      overflow-x: auto; 
      gap: 0;
      position: relative;
    }
    .steps::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--green) 100%);
      border-radius: var(--radius) var(--radius) 0 0;
      opacity: 0;
      transition: opacity var(--t);
    }
    .steps.active::before {
      opacity: 1;
    }
    .step { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      flex-shrink: 0; 
      transition: all var(--t);
      padding: 4px 0;
    }
    .step.inactive { 
      opacity: 0.4; 
    }
    .step-num { 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      border: 2px solid var(--border-2); 
      display: grid; 
      place-items: center; 
      font-size: 13px; 
      font-weight: 700; 
      color: var(--ink-3); 
      background: var(--bg2); 
      flex-shrink: 0; 
      transition: all var(--t);
      position: relative;
    }
    .step.active .step-num { 
      background: var(--accent); 
      border-color: var(--accent); 
      color: #fff; 
      box-shadow: 0 4px 16px rgba(37,99,235,.4);
      transform: scale(1.1);
    }
    .step.done .step-num   { 
      background: var(--green);  
      border-color: var(--green);  
      color: #fff;
      transform: scale(1);
    }
    .step.done .step-num::after {
      content: '✓';
      position: absolute;
      font-size: 16px;
    }
    .step-label { 
      font-size: 14px; 
      font-weight: 600; 
      color: var(--ink-2); 
      white-space: nowrap;
      transition: all var(--t);
    }
    .step.active .step-label { 
      color: var(--accent);
      transform: translateY(-1px);
    }
    .step.done   .step-label { 
      color: var(--green);  
    }
    .step-sep { 
      flex: 1; 
      height: 2px; 
      background: var(--border); 
      margin: 0 16px; 
      min-width: 24px;
      position: relative;
      overflow: hidden;
    }
    .step.done + .step-sep::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      background: var(--green);
      animation: progressFill 0.4s ease-out;
    }

    /* ── MAIN GRID ── */
    .main-grid { 
      display: grid; 
      grid-template-columns: 400px 1fr; 
      gap: 24px; 
      align-items: start;
      animation: fadeSlideUp 0.7s ease-out 0.2s both;
    }
    @media (max-width: 980px) { 
      .main-grid { grid-template-columns: 1fr; } 
      .upload-card { position: relative !important; top: 0 !important; }
    }

    /* ── UPLOAD CARD ── */
    .upload-card { 
      background: var(--surface); 
      border: 1px solid var(--border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-lg); 
      overflow: hidden; 
      position: sticky; 
      top: 24px;
      transition: all var(--t);
    }
    .upload-card:hover {
      box-shadow: 0 12px 32px rgba(15,22,40,0.14), 0 20px 56px rgba(15,22,40,0.14);
    }
    .card-hero {
      background: linear-gradient(140deg, #2563eb 0%, #1d4ed8 55%, #1e40af 100%);
      padding: 28px 28px; 
      position: relative; 
      overflow: hidden;
    }
    .card-hero::before {
      content: ''; 
      position: absolute; 
      inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E");
      animation: patternSlide 20s linear infinite;
    }
    @keyframes patternSlide {
      0% { transform: translate(0, 0); }
      100% { transform: translate(60px, 60px); }
    }
    .card-eyebrow { 
      font-size: 11px; 
      font-weight: 700; 
      letter-spacing: .12em; 
      text-transform: uppercase; 
      color: rgba(255,255,255,.75); 
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-hero h2 { 
      font-family: var(--font-display); 
      font-size: 24px; 
      font-style: italic; 
      color: #fff; 
      line-height: 1.3; 
      margin-bottom: 18px;
      position: relative;
    }
    .fpills { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
    }
    .fpill { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      background: rgba(255,255,255,.15); 
      border: 1px solid rgba(255,255,255,.22); 
      border-radius: 24px; 
      padding: 6px 12px; 
      font-size: 12px; 
      font-weight: 600; 
      color: #fff;
      transition: all var(--t);
    }
    .fpill:hover {
      background: rgba(255,255,255,.22);
      transform: translateY(-2px);
    }
    .fdot { 
      width: 7px; 
      height: 7px; 
      border-radius: 50%; 
      background: #86efac;
      box-shadow: 0 0 8px rgba(134, 239, 172, .6);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .6; }
    }
    .card-body { 
      padding: 24px 28px 28px; 
      display: grid; 
      gap: 16px; 
    }

    /* ── DROPZONE ── */
    .dropzone { 
      border: 2px dashed var(--border-2); 
      border-radius: var(--radius-sm); 
      padding: 28px 20px; 
      cursor: pointer; 
      text-align: center; 
      background: var(--surface-2); 
      transition: all var(--t-slow); 
      position: relative;
    }
    .dropzone:hover, .dropzone.dragging { 
      border-color: var(--accent); 
      background: var(--accent-soft); 
      transform: translateY(-2px); 
      box-shadow: 0 8px 28px rgba(37,99,235,.15), inset 0 0 0 1px rgba(37,99,235,.1);
    }
    .dropzone input { 
      position: absolute; 
      inset: 0; 
      opacity: 0; 
      cursor: pointer; 
      width: 100%; 
      height: 100%; 
    }
    .dz-icon { 
      width: 52px; 
      height: 52px; 
      background: var(--accent-soft); 
      border: 1px solid rgba(37,99,235,.2); 
      border-radius: 13px; 
      display: grid; 
      place-items: center; 
      margin: 0 auto 12px; 
      color: var(--accent); 
      transition: all var(--t);
    }
    .dropzone:hover .dz-icon, .dropzone.dragging .dz-icon { 
      background: var(--accent); 
      color: #fff; 
      border-color: var(--accent);
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 8px 24px rgba(37,99,235,.3);
    }
    .dz-title { 
      font-size: 15px; 
      font-weight: 700; 
      color: var(--ink); 
      margin-bottom: 4px; 
    }
    .dz-sub   { 
      font-size: 13px; 
      color: var(--ink-3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .dz-sub span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* file row */
    .file-row { 
      display: none; 
      align-items: center; 
      gap: 12px; 
      padding: 12px 16px; 
      background: var(--green-soft); 
      border: 1px solid #bbf7d0; 
      border-radius: var(--radius-sm); 
      animation: slideDown .25s ease; 
    }
    .file-row.show { display: flex; }
    .file-icon {
      width: 36px;
      height: 36px;
      background: var(--green);
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: #fff;
      flex-shrink: 0;
    }
    .file-info {
      flex: 1;
      min-width: 0;
    }
    .file-name { 
      font-size: 14px; 
      font-weight: 600; 
      color: var(--green); 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap;
      display: block;
    }
    .file-size {
      font-size: 12px;
      color: var(--ink-3);
      margin-top: 2px;
    }
    .clear-btn { 
      border: none; 
      background: rgba(220,38,38,.1); 
      cursor: pointer; 
      color: var(--red); 
      display: grid; 
      place-items: center; 
      padding: 6px; 
      border-radius: 6px; 
      transition: all var(--t); 
      flex-shrink: 0;
      width: 32px;
      height: 32px;
    }
    .clear-btn:hover { 
      background: rgba(220,38,38,.2);
      transform: scale(1.1);
    }

    /* pdf thumb */
    .pdf-thumb { 
      width: 100%; 
      height: 200px; 
      border: 1px solid var(--border); 
      border-radius: var(--radius-sm); 
      background: var(--surface-2); 
      display: none; 
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    .pdf-thumb::before {
      content: 'PDF Preview';
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(15,22,40,.8);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      z-index: 1;
    }
    .pdf-thumb embed { 
      width: 100%; 
      height: 100%; 
    }

    /* ── BUTTONS ── */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      border: none; 
      border-radius: var(--radius-sm); 
      font-family: var(--font-body); 
      font-weight: 700; 
      cursor: pointer; 
      transition: all var(--t); 
      white-space: nowrap; 
      text-decoration: none; 
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::before {
      width: 300px;
      height: 300px;
    }
    .btn:disabled { 
      opacity: .6; 
      cursor: not-allowed; 
      pointer-events: none; 
    }
    .btn-primary  { 
      background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
      color: #fff; 
      padding: 14px 24px; 
      box-shadow: 0 4px 14px rgba(37,99,235,.35); 
      width: 100%;
      font-size: 15px;
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, var(--accent-hover) 0%, #1e3a8a 100%);
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(37,99,235,.45); 
    }
    .btn-dl       { 
      background: linear-gradient(135deg, var(--green) 0%, #15803d 100%);
      color: #fff; 
      padding: 14px 24px; 
      box-shadow: 0 4px 14px rgba(22,163,74,.3); 
      width: 100%;
      font-size: 15px;
    }
    .btn-dl:hover { 
      background: linear-gradient(135deg, #15803d 0%, #166534 100%);
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(22,163,74,.4); 
    }
    .btn-icon     { 
      background: var(--surface); 
      border: 1px solid var(--border); 
      border-radius: var(--radius-xs); 
      padding: 9px; 
      color: var(--ink-2);
      width: 36px;
      height: 36px;
    }
    .btn-icon:hover { 
      background: var(--bg2); 
      color: var(--ink);
      border-color: var(--border-2);
      transform: translateY(-1px);
    }
    .btn-row { 
      display: grid; 
      gap: 12px; 
    }

    /* status */
    .status-bar { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 12px 16px; 
      border-radius: var(--radius-sm); 
      font-size: 13px; 
      font-weight: 600;
      transition: all var(--t);
    }
    .status-bar.idle    { background: var(--bg2);       color: var(--ink-3); border: 1px solid var(--border); }
    .status-bar.ok      { background: var(--green-soft); color: var(--green); border: 1px solid #bbf7d0; }
    .status-bar.warn    { background: var(--amber-soft); color: var(--amber); border: 1px solid #fde68a; }
    .status-bar.error   { background: var(--red-soft);   color: var(--red); border: 1px solid #fecaca; }
    .status-bar.loading { background: var(--accent-soft);color: var(--accent); border: 1px solid #bfdbfe; }
    .s-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      flex-shrink: 0; 
    }
    .idle    .s-dot { background: var(--ink-3); }
    .ok      .s-dot { background: var(--green);  animation: pgn 1.8s infinite; }
    .warn    .s-dot { background: var(--amber); }
    .error   .s-dot { background: var(--red); animation: shake 0.5s; }
    .loading .s-dot { background: var(--accent); animation: pbl 1.1s infinite; }
    @keyframes pgn { 0%,100%{ box-shadow:0 0 0 0 rgba(22,163,74,.5)  } 50%{ box-shadow:0 0 0 6px rgba(22,163,74,0)   } }
    @keyframes pbl { 0%,100%{ box-shadow:0 0 0 0 rgba(37,99,235,.5)  } 50%{ box-shadow:0 0 0 6px rgba(37,99,235,0)   } }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
    .prog-wrap { 
      height: 4px; 
      background: var(--border); 
      border-radius: 4px; 
      display: none;
      overflow: hidden;
    }
    .prog-wrap.show { display: block; }
    .prog-fill { 
      height: 100%; 
      background: linear-gradient(90deg, var(--accent), var(--green));
      border-radius: 4px; 
      transition: width .5s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
      position: relative;
    }
    .prog-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* ── PREVIEW CARD ── */
    .preview-card { 
      background: var(--surface); 
      border: 1px solid var(--border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-lg); 
      overflow: hidden;
      transition: all var(--t);
    }
    .preview-card:hover {
      box-shadow: 0 12px 32px rgba(15,22,40,0.14), 0 20px 56px rgba(15,22,40,0.14);
    }
    .prev-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 16px; 
      padding: 20px 26px; 
      border-bottom: 1px solid var(--border); 
      flex-wrap: wrap;
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
    }
    .prev-header-l { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
      flex: 1; 
      min-width: 0; 
    }
    .prev-h-icon { 
      width: 40px; 
      height: 40px; 
      background: var(--accent-soft); 
      border: 1px solid rgba(37,99,235,.2); 
      border-radius: 10px; 
      display: grid; 
      place-items: center; 
      color: var(--accent); 
      flex-shrink: 0;
      transition: all var(--t);
    }
    .prev-h-icon:hover {
      transform: rotate(5deg) scale(1.05);
    }
    .prev-h-title { 
      font-size: 16px; 
      font-weight: 700;
      color: var(--ink);
    }
    .prev-h-sub   { 
      font-size: 13px; 
      color: var(--ink-3); 
      margin-top: 2px; 
    }
    .prev-header-r { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      flex-shrink: 0; 
    }
    .badge { 
      padding: 6px 14px; 
      border-radius: 24px; 
      font-size: 13px; 
      font-weight: 700; 
      background: var(--bg2); 
      color: var(--ink-2); 
      border: 1px solid var(--border); 
      white-space: nowrap;
      transition: all var(--t);
    }
    .badge.hi { 
      background: linear-gradient(135deg, var(--accent-soft) 0%, #dbeafe 100%);
      color: var(--accent); 
      border-color: #bfdbfe;
      box-shadow: 0 2px 8px rgba(37,99,235,.15);
    }

    /* toolbar */
    .prev-toolbar { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 14px 26px; 
      border-bottom: 1px solid var(--border); 
      background: var(--surface-2); 
      flex-wrap: wrap; 
    }
    .tabs-row { 
      display: flex; 
      gap: 8px; 
      flex: 1; 
      overflow-x: auto; 
      min-width: 0;
      padding: 2px 0;
    }
    .tabs-row::-webkit-scrollbar { height: 4px; }
    .tabs-row::-webkit-scrollbar-track { background: var(--bg2); border-radius: 4px; }
    .tabs-row::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 4px; }
    .tab { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      padding: 8px 16px; 
      border: 1px solid var(--border); 
      border-radius: var(--radius-xs); 
      background: var(--surface); 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--ink-2); 
      cursor: pointer; 
      white-space: nowrap; 
      transition: all var(--t);
      position: relative;
    }
    .tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      transform: scaleX(0);
      transition: transform var(--t);
    }
    .tab:hover { 
      background: var(--bg2); 
      color: var(--ink);
      transform: translateY(-1px);
      border-color: var(--border-2);
    }
    .tab.active { 
      background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
      border-color: var(--accent); 
      color: #fff; 
      box-shadow: 0 4px 12px rgba(37,99,235,.32);
      transform: translateY(-1px);
    }
    .tab.active::before {
      transform: scaleX(1);
    }
    .tab-cnt { 
      font-size: 11px; 
      font-weight: 700; 
      background: rgba(255,255,255,.25); 
      border-radius: 6px; 
      padding: 2px 7px;
      min-width: 24px;
      text-align: center;
    }
    .tab:not(.active) .tab-cnt { 
      background: var(--bg2); 
      color: var(--ink-3); 
    }
    .search-wrap { 
      position: relative; 
      flex-shrink: 0; 
    }
    .search-wrap svg { 
      position: absolute; 
      left: 11px; 
      top: 50%; 
      transform: translateY(-50%); 
      color: var(--ink-3); 
      pointer-events: none;
      transition: color var(--t);
    }
    .search-in { 
      border: 1px solid var(--border); 
      border-radius: var(--radius-xs); 
      padding: 9px 14px 9px 36px; 
      font-family: var(--font-body); 
      font-size: 13px; 
      color: var(--ink); 
      background: var(--surface); 
      outline: none; 
      width: 200px; 
      transition: all var(--t); 
    }
    .search-in:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
      background: #fff;
    }
    .search-in:focus + svg {
      color: var(--accent);
    }
    .search-in::placeholder {
      color: var(--ink-3);
    }

    /* meta bar */
    .meta-bar { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 12px 26px; 
      border-bottom: 1px solid var(--border); 
      background: var(--surface); 
      flex-wrap: wrap; 
      display: none; 
    }
    .pill { 
      display: inline-flex; 
      align-items: center;
      gap: 5px;
      padding: 5px 12px; 
      border-radius: 24px; 
      font-size: 12px; 
      font-weight: 600; 
      background: var(--bg2); 
      color: var(--ink-2); 
      border: 1px solid var(--border);
      transition: all var(--t);
    }
    .pill:hover {
      background: var(--surface-2);
      transform: translateY(-1px);
    }
    .pill-hi { 
      background: linear-gradient(135deg, var(--accent-soft) 0%, #dbeafe 100%);
      color: var(--accent); 
      border-color: #bfdbfe; 
    }
    .meta-sp { flex: 1; }

    /* table */
    .tbl-scroll { 
      overflow: auto; 
      max-height: 560px; 
    }
    .tbl-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .tbl-scroll::-webkit-scrollbar-track { background: var(--bg2); }
    .tbl-scroll::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 6px; }
    .tbl-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    table.grid { 
      width: max(100%,600px); 
      border-collapse: collapse; 
      font-size: 14px; 
    }
    table.grid thead th { 
      position: sticky; 
      top: 0; 
      z-index: 4; 
      background: linear-gradient(180deg, #0f1628 0%, #1a2332 100%);
      color: #e2e8f8; 
      font-size: 12px; 
      font-weight: 700; 
      text-transform: uppercase; 
      letter-spacing: .05em; 
      padding: 12px 14px; 
      border-right: 1px solid rgba(255,255,255,.08); 
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    table.grid thead th:first-child { 
      width: 60px; 
      text-align: center; 
      background: linear-gradient(180deg, #0a0f1e 0%, #111825 100%);
      z-index: 5; 
      position: sticky; 
      left: 0; 
    }
    table.grid tbody tr:hover td, table.grid tbody tr:hover th { 
      background: var(--accent-soft) !important;
      cursor: pointer;
    }
    table.grid tbody tr.smatch td, table.grid tbody tr.smatch th { 
      outline: 2px solid var(--accent); 
      outline-offset: -1px;
      animation: highlight 0.3s ease;
    }
    @keyframes highlight {
      0% { background: transparent; }
      50% { background: rgba(37,99,235,.15); }
      100% { background: transparent; }
    }
    table.grid td { 
      padding: 10px 14px; 
      border-right: 1px solid var(--border); 
      border-bottom: 1px solid var(--border); 
      background: var(--surface); 
      color: var(--ink); 
      max-width: 320px; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap; 
      vertical-align: middle; 
      transition: all var(--t); 
    }
    table.grid td.mhit { 
      background: #fef9c3 !important;
      font-weight: 600;
    }
    table.grid td span.mhl { 
      background: #fde047; 
      border-radius: 3px; 
      padding: 1px 4px;
      box-shadow: 0 0 0 2px #fef9c3;
    }
    table.grid tbody th.rn { 
      position: sticky; 
      left: 0; 
      z-index: 2; 
      background: var(--bg2); 
      color: var(--ink-3); 
      font-size: 12px; 
      font-family: var(--font-mono); 
      font-weight: 600; 
      padding: 10px; 
      text-align: center; 
      border-right: 1px solid var(--border-2); 
      border-bottom: 1px solid var(--border); 
      width: 60px; 
      white-space: nowrap;
      box-shadow: 2px 0 4px rgba(0,0,0,.04);
    }
    table.grid tbody tr:hover th.rn { 
      background: #dce5f9;
      color: var(--accent);
      font-weight: 700;
    }

    /* empty */
    .empty { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      gap: 16px; 
      min-height: 360px; 
      padding: 48px; 
      color: var(--ink-3); 
      text-align: center; 
    }
    .empty-ico { 
      width: 64px; 
      height: 64px; 
      background: linear-gradient(135deg, var(--bg2) 0%, var(--surface-2) 100%);
      border: 1px solid var(--border); 
      border-radius: 16px; 
      display: grid; 
      place-items: center; 
      color: var(--ink-3);
      box-shadow: var(--shadow-sm);
    }
    .empty h4 { 
      font-size: 16px; 
      font-weight: 700; 
      color: var(--ink-2); 
    }
    .empty p  { 
      font-size: 14px; 
      max-width: 280px; 
      line-height: 1.6;
      color: var(--ink-3);
    }

    /* ── TOAST ── */
    #toasts { 
      position: fixed; 
      bottom: 32px; 
      right: 28px; 
      z-index: 9999; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      pointer-events: none; 
    }
    .toast { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      background: linear-gradient(135deg, #0f1628 0%, #1a2332 100%);
      color: #e2e8f8; 
      padding: 16px 20px; 
      border-radius: 14px; 
      font-size: 14px; 
      font-weight: 600; 
      box-shadow: 0 12px 36px rgba(0,0,0,.4), 0 0 0 1px rgba(255,255,255,.1);
      pointer-events: all; 
      animation: tin .3s cubic-bezier(.34,1.56,.64,1); 
      max-width: 360px;
      backdrop-filter: blur(10px);
    }
    .toast.out { 
      animation: tout .25s ease forwards; 
    }
    .toast-g { 
      border-left: 3px solid var(--green);
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
    }
    .toast-b { 
      border-left: 3px solid var(--accent); 
    }
    .toast-r { 
      border-left: 3px solid var(--red);
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    }
    .toast svg {
      flex-shrink: 0;
    }
    @keyframes tin  { from{opacity:0;transform:translateX(24px) scale(0.9)} to{opacity:1;transform:translateX(0) scale(1)} }
    @keyframes tout { from{opacity:1;transform:translateX(0) scale(1)}     to{opacity:0;transform:translateX(24px) scale(0.9)} }

    @keyframes spin      { to { transform: rotate(360deg); } }
    @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeSlideDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeSlideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    @keyframes progressFill { from{width:0} to{width:100%} }
    
    .spin { 
      animation: spin .75s linear infinite; 
      display: inline-block; 
    }

    /* ── HELPER TEXT ── */
    .helper-box {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1px solid #bfdbfe;
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-top: 8px;
      display: flex;
      align-items: start;
      gap: 10px;
      animation: slideDown 0.3s ease;
    }
    .helper-box svg {
      color: var(--accent);
      flex-shrink: 0;
      margin-top: 2px;
    }
    .helper-box p {
      font-size: 12px;
      color: var(--ink-2);
      line-height: 1.5;
      margin: 0;
    }
    .helper-box strong {
      color: var(--accent);
      font-weight: 700;
    }

    /* ── RESPONSIVE ── */
    @media (max-width: 768px) {
      .app { padding: 20px 16px 60px; gap: 20px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      .topbar-tag { display: none; }
      .steps { padding: 14px 20px; gap: 0; }
      .step-label { font-size: 13px; }
      .step-num { width: 28px; height: 28px; font-size: 12px; }
      .step-sep { min-width: 16px; margin: 0 10px; }
      .search-in { width: 140px; }
      .prev-toolbar { flex-direction: column; align-items: stretch; }
      .tabs-row { width: 100%; }
      .search-wrap { width: 100%; }
      .search-in { width: 100%; }
      .card-hero h2 { font-size: 20px; }
      .empty { min-height: 280px; padding: 32px 24px; }
      table.grid { font-size: 13px; }
      table.grid thead th { font-size: 11px; padding: 10px 12px; }
      table.grid td { padding: 8px 12px; }
    }

    @media (max-width: 640px) {
      .brand-name { font-size: 18px; }
      .brand-icon { width: 36px; height: 36px; }
      .file-row { flex-direction: column; align-items: stretch; }
      .file-info { text-align: center; }
      .clear-btn { align-self: center; }
      .fpills { justify-content: center; }
      #toasts { right: 16px; left: 16px; bottom: 20px; }
      .toast { max-width: 100%; }
    }

    /* ── ACCESSIBILITY ── */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus visible for keyboard navigation */
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --border: #000;
        --border-2: #000;
      }
    }
  </style>
</head>
<body>
<div id="toasts"></div>
<main class="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      </div>
      <div>
        <span class="brand-name">TablePull</span>
        <div class="brand-tagline">Fast, accurate PDF table extraction</div>
      </div>
    </div>
    <span class="topbar-tag">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      100% Client-Side Processing
    </span>
  </header>

  <!-- STEPS -->
  <div class="steps-wrapper">
    <nav class="steps">
      <div class="step active" id="s1"><div class="step-num">1</div><span class="step-label">Upload PDF</span></div>
      <div class="step-sep"></div>
      <div class="step inactive" id="s2"><div class="step-num">2</div><span class="step-label">Analyze</span></div>
      <div class="step-sep"></div>
      <div class="step inactive" id="s3"><div class="step-num">3</div><span class="step-label">Preview</span></div>
      <div class="step-sep"></div>
      <div class="step inactive" id="s4"><div class="step-num">4</div><span class="step-label">Download</span></div>
    </nav>
  </div>

  <!-- GRID -->
  <div class="main-grid">

    <!-- LEFT -->
    <aside class="upload-card">
      <div class="card-hero">
        <p class="card-eyebrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          POWERED BY AI
        </p>
        <h2>Extract tables with<br/>colors & formatting intact.</h2>
        <div class="fpills">
          <div class="fpill"><span class="fdot"></span>Preserves highlights</div>
          <div class="fpill"><span class="fdot"></span>Multi-sheet support</div>
          <div class="fpill"><span class="fdot"></span>Instant preview</div>
          <div class="fpill"><span class="fdot"></span>No data upload</div>
        </div>
      </div>

      <div class="card-body">
        <form id="uform" action="/extract" method="post" enctype="multipart/form-data">

          <label class="dropzone" id="dz" for="fi">
            <div class="dz-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
            </div>
            <div class="dz-title" id="dz-title">Drop your PDF here or click to browse</div>
            <div class="dz-sub">
              <span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                PDF only
              </span>
              <span>•</span>
              <span>Max 50 MB</span>
            </div>
            <input type="file" id="fi" name="file" accept="application/pdf" required />
          </label>

          <div class="file-row" id="frow">
            <div class="file-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div class="file-info">
              <span class="file-name" id="fname"></span>
              <div class="file-size" id="fsize"></div>
            </div>
            <button type="button" class="clear-btn" id="clrbtn" aria-label="Remove file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>

          <div class="pdf-thumb" id="pthumb"><embed id="pembed" type="application/pdf" style="width:100%;height:100%"/></div>

          <div class="helper-box" style="display: none;" id="helperBox">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <p><strong>Pro tip:</strong> Works best with PDFs containing structured tables. Financial reports, data sheets, and academic papers work great!</p>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn btn-primary" id="abtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Analyze Tables
            </button>
            <button type="button" class="btn btn-dl" id="dlbtn" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Download Excel
            </button>
          </div>

          <div class="status-bar idle" id="sbar">
            <span class="s-dot"></span>
            <span id="stxt">Ready to extract tables from your PDF</span>
          </div>
          <div class="prog-wrap" id="pwrap"><div class="prog-fill" id="pfill"></div></div>
        </form>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="preview-card" id="prev-card">
      <div class="prev-header">
        <div class="prev-header-l">
          <div class="prev-h-icon">
            <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </div>
          <div>
            <div class="prev-h-title">Live Workbook Preview</div>
            <div class="prev-h-sub">Interactive Excel-style view with preserved formatting</div>
          </div>
        </div>
        <div class="prev-header-r">
          <div class="badge" id="tcount">No tables</div>
          <button type="button" class="btn btn-icon" id="csvbtn" title="Copy sheet as CSV" style="display:none">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
          <button type="button" class="btn btn-icon" id="fsbtn" title="Fullscreen preview" style="display:none">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
          </button>
        </div>
      </div>

      <div class="prev-toolbar">
        <div class="tabs-row" id="stabs"></div>
        <div class="search-wrap">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" class="search-in" id="srch" placeholder="Search in table..." autocomplete="off"/>
        </div>
      </div>

      <div class="meta-bar" id="mbar">
        <span class="pill pill-hi" id="mrows">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          —
        </span>
        <span class="pill" id="mcols">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
          —
        </span>
        <span class="pill" id="msheet">—</span>
        <div class="meta-sp"></div>
        <span class="pill" style="color:var(--ink-3);font-size:11px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          Formatting preserved
        </span>
      </div>

      <div id="tarea">
        <div class="empty" id="estate">
          <div class="empty-ico">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </div>
          <h4>No tables extracted yet</h4>
          <p>Upload a PDF document and click "Analyze Tables" to see an interactive preview of your extracted data here.</p>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  /* ── STATE ── */
  let tables = [], activeIdx = 0, blobUrl = null, dlName = null;

  /* ── ELEMENTS ── */
  const fi    = document.getElementById('fi');
  const dz    = document.getElementById('dz');
  const dzT   = document.getElementById('dz-title');
  const frow  = document.getElementById('frow');
  const fname = document.getElementById('fname');
  const fsize = document.getElementById('fsize');
  const clr   = document.getElementById('clrbtn');
  const pthumb= document.getElementById('pthumb');
  const pembd = document.getElementById('pembed');
  const abtn  = document.getElementById('abtn');
  const dlbtn = document.getElementById('dlbtn');
  const sbar  = document.getElementById('sbar');
  const stxt  = document.getElementById('stxt');
  const pw    = document.getElementById('pwrap');
  const pf    = document.getElementById('pfill');
  const stabs = document.getElementById('stabs');
  const tarea = document.getElementById('tarea');
  const estat = document.getElementById('estate');
  const tcount= document.getElementById('tcount');
  const mbar  = document.getElementById('mbar');
  const mrows = document.getElementById('mrows');
  const mcols = document.getElementById('mcols');
  const msht  = document.getElementById('msheet');
  const srch  = document.getElementById('srch');
  const csvb  = document.getElementById('csvbtn');
  const fsb   = document.getElementById('fsbtn');
  const form  = document.getElementById('uform');
  const helperBox = document.getElementById('helperBox');
  const stepsEl = document.querySelector('.steps');

  /* ── STEPS ── */
  function setStep(n) {
    for (let i=1;i<=4;i++) {
      const el=document.getElementById('s'+i);
      el.className = i<n ? 'step done' : i===n ? 'step active' : 'step inactive';
    }
    if (n > 1) stepsEl.classList.add('active');
    else stepsEl.classList.remove('active');
  }

  /* ── TOAST ── */
  function toast(msg, type='b') {
    const tc=document.getElementById('toasts'), d=document.createElement('div');
    d.className=`toast toast-${type}`;
    const ic={
      g:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
      b:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
      r:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
    };
    d.innerHTML=`${ic[type]||ic.b}<span>${msg}</span>`;
    tc.appendChild(d);
    setTimeout(()=>{ d.classList.add('out'); setTimeout(()=>d.remove(),280); },3500);
  }

  /* ── STATUS ── */
  function st(text, tone='idle') { 
    sbar.className=`status-bar ${tone}`; 
    stxt.textContent=text; 
  }
  function prog(pct, show=true)  { 
    pw.classList.toggle('show',show); 
    pf.style.width=pct+'%'; 
  }

  /* ── FILE ── */
  fi.addEventListener('change', onFile);
  clr.addEventListener('click', clearFile);
  
  function onFile() {
    const f=fi.files[0]; 
    if(!f) return;
    
    const sizeMB = (f.size/1024/1024).toFixed(2);
    
    dzT.textContent=f.name;
    fname.textContent=f.name;
    fsize.textContent=`${sizeMB} MB`;
    frow.classList.add('show');
    pembd.src=URL.createObjectURL(f);
    pthumb.style.display='block';
    helperBox.style.display='flex';
    st('PDF loaded successfully! Ready to analyze.','ok');
    setStep(1); 
    resetPrev(); 
    dlbtn.disabled=true; 
    csvb.style.display='none'; 
    fsb.style.display='none';
    
    // Show helper after a short delay
    setTimeout(() => {
      if (helperBox) helperBox.style.display = 'flex';
    }, 500);
  }
  
  function clearFile() {
    fi.value=''; 
    dzT.textContent='Drop your PDF here or click to browse';
    frow.classList.remove('show'); 
    pthumb.style.display='none'; 
    pembd.removeAttribute('src');
    helperBox.style.display='none';
    st('Ready to extract tables from your PDF','idle'); 
    prog(0,false); 
    setStep(1); 
    resetPrev();
    dlbtn.disabled=true; 
    csvb.style.display='none'; 
    fsb.style.display='none'; 
    blobUrl=null;
  }
  
  /* drag */
  ['dragover','dragenter'].forEach(e=>dz.addEventListener(e,ev=>{
    ev.preventDefault();
    dz.classList.add('dragging');
  }));
  
  ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{
    ev.preventDefault();
    dz.classList.remove('dragging');
  }));
  
  dz.addEventListener('drop',ev=>{
    const f=ev.dataTransfer?.files?.[0]; 
    if(!f) return;
    if(f.type!=='application/pdf'){
      toast('Please drop a PDF file only.','r');
      return;
    }
    const dt=new DataTransfer(); 
    dt.items.add(f); 
    fi.files=dt.files; 
    onFile();
  });

  /* ── RESET ── */
  function resetPrev() {
    tables=[]; 
    activeIdx=0; 
    stabs.innerHTML='';
    tarea.innerHTML=''; 
    tarea.appendChild(estat);
    tcount.textContent='No tables'; 
    tcount.className='badge';
    mbar.style.display='none';
    srch.value='';
  }

  /* ── TABS ── */
  function renderTabs() {
    stabs.innerHTML='';
    tables.forEach((t,i)=>{
      const b=document.createElement('button'); 
      b.type='button';
      b.className=`tab ${i===activeIdx?'active':''}`;
      b.innerHTML=`${t.title||`Sheet ${i+1}`}<span class="tab-cnt">${t.rows?.length??0}</span>`;
      b.addEventListener('click',()=>{
        activeIdx=i;
        renderTabs();
        renderTable();
      });
      stabs.appendChild(b);
    });
  }

  /* ── TABLE ── */
  function renderTable(q='') {
    if(!tables.length){ 
      tarea.innerHTML=''; 
      tarea.appendChild(estat); 
      mbar.style.display='none'; 
      return; 
    }
    
    const t=tables[activeIdx], 
          cols=t.rows.reduce((m,r)=>Math.max(m,r.length),0), 
          s=q.toLowerCase().trim();
    
    mrows.innerHTML=`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>${t.rows.length} rows`;
    
    mcols.innerHTML=`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>${cols} columns`;
    
    msht.textContent=`Sheet ${activeIdx+1} of ${tables.length}`;
    mbar.style.display='flex';
    
    const wrap=document.createElement('div'); 
    wrap.className='tbl-scroll';
    const tbl=document.createElement('table'); 
    tbl.className='grid';
    
    /* head */
    const hd=document.createElement('thead'), 
          hr=document.createElement('tr');
    const ch=document.createElement('th'); 
    ch.textContent='#'; 
    hr.appendChild(ch);
    
    for(let c=0;c<cols;c++){
      const th=document.createElement('th');
      th.textContent=`COL ${c+1}`;
      hr.appendChild(th);
    }
    hd.appendChild(hr); 
    tbl.appendChild(hd);
    
    /* body */
    const tb=document.createElement('tbody'); 
    let hits=0;
    
    t.rows.forEach((row,ri)=>{
      const tr=document.createElement('tr');
      const rh=document.createElement('th'); 
      rh.className='rn'; 
      rh.textContent=ri+1; 
      tr.appendChild(rh);
      
      let rowHit=false;
      for(let c=0;c<cols;c++){
        const td=document.createElement('td'), 
              cell=row[c]??'', 
              color=t.highlights?.[ri]?.[c];
        
        if(color) td.style.background=`#${color.slice(2)}`;
        
        if(s && String(cell).toLowerCase().includes(s)){
          rowHit=true; 
          td.classList.add('mhit');
          td.innerHTML=String(cell).replace(
            new RegExp(`(${esc(s)})`, 'gi'),
            '<span class="mhl">$1</span>'
          );
        } else { 
          td.textContent=cell; 
        }
        
        // Add title for full text on hover
        td.title = cell;
        tr.appendChild(td);
      }
      
      if(s&&rowHit){
        tr.classList.add('smatch');
        hits++;
      }
      tb.appendChild(tr);
    });
    
    tbl.appendChild(tb); 
    wrap.appendChild(tbl); 
    tarea.innerHTML=''; 
    tarea.appendChild(wrap);
    
    if(s) { 
      if(!hits) toast(`No matches found for "${q}"`, 'r'); 
      else toast(`Found ${hits} matching row${hits>1?'s':''}`, 'g'); 
    }
  }
  
  function esc(s){
    return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  }
  
  let stimer; 
  srch.addEventListener('input',()=>{
    clearTimeout(stimer);
    stimer=setTimeout(()=>renderTable(srch.value),300);
  });

  /* ── ANALYZE ── */
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    
    if(!fi.files.length){
      toast('Please choose a PDF file first.','r');
      return;
    }
    
    abtn.disabled=true;
    abtn.innerHTML=`<span class="spin"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></span>Analyzing tables…`;
    st('Analyzing PDF structure and extracting tables…','loading'); 
    prog(20,true); 
    setStep(2); 
    resetPrev(); 
    dlbtn.disabled=true;
    
    const fd=new FormData(form);
    
    try {
      let p=20; 
      const tk=setInterval(()=>{
        p=Math.min(p+5,85);
        prog(p);
      },500);
      
      const r=await fetch('/analyze',{method:'POST',body:fd});
      clearInterval(tk);
      
      if(!r.ok) throw new Error((await r.text())||'Analysis failed.');
      
      const res=await r.json();
      prog(100);
      
      if(res.table_count===0){
        st('No tables detected in this PDF.','warn'); 
        toast('No tables found. Try a different PDF with structured data.','r');
        prog(0,false); 
        return;
      }
      
      tables=res.tables||[]; 
      activeIdx=0;
      const n=res.table_count;
      
      tcount.textContent=`${n} table${n>1?'s':''} found`; 
      tcount.className='badge hi';
      renderTabs(); 
      renderTable();
      
      st(`Successfully extracted ${n} table${n>1?'s':''} — preparing download…`,'ok');
      toast(`🎉 Found ${n} table${n>1?'s':''}! Preparing Excel file…`,'g'); 
      setStep(3);
      csvb.style.display='grid'; 
      fsb.style.display='grid';
      
      /* fetch xlsx */
      prog(85,true);
      const fd2=new FormData(form), 
            dr=await fetch('/extract',{method:'POST',body:fd2});
      
      if(!dr.ok) throw new Error((await dr.text())||'Excel generation failed.');
      
      const blob=await dr.blob();
      blobUrl=URL.createObjectURL(blob);
      dlName=(fi.files[0]?.name?.replace(/\.pdf$/i,'')||'tables')+'-extracted.xlsx';
      
      dlbtn.disabled=false; 
      setStep(4);
      st(`Excel file ready! Click "Download Excel" to save.`,'ok');
      prog(100); 
      setTimeout(()=>prog(0,false),800);
      
    } catch(err){
      console.error(err); 
      st(err.message||'Something went wrong during analysis.','error');
      toast(err.message||'Analysis failed. Please try again.','r'); 
      prog(0,false);
    } finally {
      abtn.disabled=false;
      abtn.innerHTML=`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Analyze Tables`;
    }
  });

  /* ── DOWNLOAD ── */
  dlbtn.addEventListener('click',()=>{
    if(!blobUrl) return;
    const a=document.createElement('a'); 
    a.href=blobUrl; 
    a.download=dlName;
    document.body.appendChild(a); 
    a.click(); 
    a.remove();
    toast('✅ Excel file downloaded successfully!','g');
  });

  /* ── COPY CSV ── */
  csvb.addEventListener('click',()=>{
    if(!tables.length) return;
    const t=tables[activeIdx];
    const csv=t.rows.map(r=>
      r.map(c=>`"${String(c??'').replace(/"/g,'""')}"`).join(',')
    ).join('\n');
    
    navigator.clipboard.writeText(csv)
      .then(()=>toast('📋 CSV data copied to clipboard!','g'))
      .catch(()=>toast('Failed to copy. Please try again.','r'));
  });

  /* ── FULLSCREEN ── */
  fsb.addEventListener('click',()=>{
    const card=document.getElementById('prev-card');
    if(!document.fullscreenElement) {
      card.requestFullscreen?.() || 
      card.webkitRequestFullscreen?.() || 
      card.mozRequestFullScreen?.();
    } else {
      document.exitFullscreen?.() || 
      document.webkitExitFullscreen?.() || 
      document.mozCancelFullScreen?.();
    }
  });
  
  document.addEventListener('fullscreenchange',()=>{
    fsb.innerHTML=document.fullscreenElement
      ?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="10" y1="14" x2="3" y2="21"/><line x1="21" y1="3" x2="14" y2="10"/></svg>`
      :`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>`;
    fsb.title=document.fullscreenElement ? 'Exit fullscreen' : 'Fullscreen preview';
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // ESC to exit fullscreen
    if (e.key === 'Escape' && document.fullscreenElement) {
      document.exitFullscreen();
    }
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      srch.focus();
    }
  });

  // Show initial welcome message
  setTimeout(() => {
    toast('👋 Welcome! Upload a PDF to extract tables instantly.', 'b');
  }, 500);
</script>
</body>
</html>
